!function(e,t){for(var i in t)e[i]=t[i]}(exports,function(e){var t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(n,s,function(t){return e[t]}.bind(null,s));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=11)}([function(e,t){e.exports=require("util")},function(e,t){e.exports=require("events")},function(e,t,i){var n=t.noop=function(){};function s(e,t,i){this.logFunction=i,this.identifier=e,this.uniqueID=t,this.buffer=[]}t.extend=function(e,t){for(var i in t)e[i]=t[i]},t.eventEmitterListenerCount=i(1).EventEmitter.listenerCount||function(e,t){return e.listeners(t).length},t.bufferAllocUnsafe=Buffer.allocUnsafe?Buffer.allocUnsafe:function(e){return new Buffer(e)},t.bufferFromString=Buffer.from?Buffer.from:function(e,t){return new Buffer(e,t)},t.BufferingLogger=function(e,t){var o=i(6)(e);if(o.enabled){var r=new s(e,t,o),a=r.log.bind(r);return a.printOutput=r.printOutput.bind(r),a.enabled=o.enabled,a}return o.printOutput=n,o},s.prototype.log=function(){return this.buffer.push([new Date,Array.prototype.slice.call(arguments)]),this},s.prototype.clear=function(){return this.buffer=[],this},s.prototype.printOutput=function(e){e||(e=this.logFunction);var t=this.uniqueID;this.buffer.forEach(function(i){var n=i[0].toLocaleString(),s=i[1].slice(),o=s[0];void 0!==o&&null!==o&&(o="%s - %s - "+o.toString(),s.splice(0,1,o,n,t),e.apply(global,s))})}},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("url")},function(e,t,i){var n=i(0),s=i(2),o=i(1).EventEmitter,r=i(9),a=i(25),c=i(27).Validation,h=s.bufferAllocUnsafe,u=s.bufferFromString;const l="open";var d="setImmediate"in global?global.setImmediate.bind(global):process.nextTick.bind(process),p=0;function f(e,t,i,n,c){if(this._debug=s.BufferingLogger("websocket:connection",++p),this._debug("constructor"),this._debug.enabled&&function(e,t){if(!e._debug.enabled)return;var i=t.emit;for(var n in t.emit=function(t){e._debug("||| Socket Event  '%s'",t),i.apply(this,arguments)},t)"function"==typeof t[n]&&-1===["emit"].indexOf(n)&&function(i){var n=t[i];t[i]="on"!==i?function(){return e._debug("||| Socket method called:  %s",i),n.apply(this,arguments)}:function(){return e._debug("||| Socket method called:  %s (%s)",i,arguments[0]),n.apply(this,arguments)}}(n)}(this,e),o.call(this),this._pingListenerCount=0,this.on("newListener",function(e){"ping"===e&&this._pingListenerCount++}).on("removeListener",function(e){"ping"===e&&this._pingListenerCount--}),this.config=c,this.socket=e,this.protocol=i,this.extensions=t,this.remoteAddress=e.remoteAddress,this.closeReasonCode=-1,this.closeDescription=null,this.closeEventEmitted=!1,this.maskOutgoingPackets=n,this.maskBytes=h(4),this.frameHeader=h(10),this.bufferList=new a,this.currentFrame=new r(this.maskBytes,this.frameHeader,this.config),this.fragmentationSize=0,this.frameQueue=[],this.connected=!0,this.state=l,this.waitingForCloseResponse=!1,this.receivedEnd=!1,this.closeTimeout=this.config.closeTimeout,this.assembleFragments=this.config.assembleFragments,this.maxReceivedMessageSize=this.config.maxReceivedMessageSize,this.outputBufferFull=!1,this.inputPaused=!1,this.receivedDataHandler=this.processReceivedData.bind(this),this._closeTimerHandler=this.handleCloseTimer.bind(this),this.socket.setNoDelay(this.config.disableNagleAlgorithm),this.socket.setTimeout(0),this.config.keepalive&&!this.config.useNativeKeepalive){if("number"!=typeof this.config.keepaliveInterval)throw new Error("keepaliveInterval must be specified and numeric if keepalive is true.");if(this._keepaliveTimerHandler=this.handleKeepaliveTimer.bind(this),this.setKeepaliveTimer(),this.config.dropConnectionOnKeepaliveTimeout){if("number"!=typeof this.config.keepaliveGracePeriod)throw new Error("keepaliveGracePeriod  must be specified and numeric if dropConnectionOnKeepaliveTimeout is true.");this._gracePeriodTimerHandler=this.handleGracePeriodTimer.bind(this)}}else if(this.config.keepalive&&this.config.useNativeKeepalive){if(!("setKeepAlive"in this.socket))throw new Error("Unable to use native keepalive: unsupported by this version of Node.");this.socket.setKeepAlive(!0,this.config.keepaliveInterval)}this.socket.removeAllListeners("error")}function m(e){return!(e<1e3)&&(e>=1e3&&e<=2999?-1!==[1e3,1001,1002,1003,1007,1008,1009,1010,1011,1012,1013,1014].indexOf(e):e>=3e3&&e<=3999||(e>=4e3&&e<=4999||!(e>=5e3)&&void 0))}f.CLOSE_REASON_NORMAL=1e3,f.CLOSE_REASON_GOING_AWAY=1001,f.CLOSE_REASON_PROTOCOL_ERROR=1002,f.CLOSE_REASON_UNPROCESSABLE_INPUT=1003,f.CLOSE_REASON_RESERVED=1004,f.CLOSE_REASON_NOT_PROVIDED=1005,f.CLOSE_REASON_ABNORMAL=1006,f.CLOSE_REASON_INVALID_DATA=1007,f.CLOSE_REASON_POLICY_VIOLATION=1008,f.CLOSE_REASON_MESSAGE_TOO_BIG=1009,f.CLOSE_REASON_EXTENSION_REQUIRED=1010,f.CLOSE_REASON_INTERNAL_SERVER_ERROR=1011,f.CLOSE_REASON_TLS_HANDSHAKE_FAILED=1015,f.CLOSE_DESCRIPTIONS={1000:"Normal connection closure",1001:"Remote peer is going away",1002:"Protocol error",1003:"Unprocessable input",1004:"Reserved",1005:"Reason not provided",1006:"Abnormal closure, no further detail available",1007:"Invalid data received",1008:"Policy violation",1009:"Message too big",1010:"Extension requested by client is required",1011:"Internal Server Error",1015:"TLS Handshake Failed"},n.inherits(f,o),f.prototype._addSocketEventListeners=function(){this.socket.on("error",this.handleSocketError.bind(this)),this.socket.on("end",this.handleSocketEnd.bind(this)),this.socket.on("close",this.handleSocketClose.bind(this)),this.socket.on("drain",this.handleSocketDrain.bind(this)),this.socket.on("pause",this.handleSocketPause.bind(this)),this.socket.on("resume",this.handleSocketResume.bind(this)),this.socket.on("data",this.handleSocketData.bind(this))},f.prototype.setKeepaliveTimer=function(){this._debug("setKeepaliveTimer"),this.config.keepalive&&!this.config.useNativeKeepalive&&(this.clearKeepaliveTimer(),this.clearGracePeriodTimer(),this._keepaliveTimeoutID=setTimeout(this._keepaliveTimerHandler,this.config.keepaliveInterval))},f.prototype.clearKeepaliveTimer=function(){this._keepaliveTimeoutID&&clearTimeout(this._keepaliveTimeoutID)},f.prototype.handleKeepaliveTimer=function(){this._debug("handleKeepaliveTimer"),this._keepaliveTimeoutID=null,this.ping(),this.config.dropConnectionOnKeepaliveTimeout?this.setGracePeriodTimer():this.setKeepaliveTimer()},f.prototype.setGracePeriodTimer=function(){this._debug("setGracePeriodTimer"),this.clearGracePeriodTimer(),this._gracePeriodTimeoutID=setTimeout(this._gracePeriodTimerHandler,this.config.keepaliveGracePeriod)},f.prototype.clearGracePeriodTimer=function(){this._gracePeriodTimeoutID&&clearTimeout(this._gracePeriodTimeoutID)},f.prototype.handleGracePeriodTimer=function(){this._debug("handleGracePeriodTimer"),this._gracePeriodTimeoutID=null,this.drop(f.CLOSE_REASON_ABNORMAL,"Peer not responding.",!0)},f.prototype.handleSocketData=function(e){this._debug("handleSocketData"),this.setKeepaliveTimer(),this.bufferList.write(e),this.processReceivedData()},f.prototype.processReceivedData=function(){if(this._debug("processReceivedData"),this.connected&&!this.inputPaused){var e=this.currentFrame;if(e.addData(this.bufferList)){var t=this;if(e.protocolError)return this._debug("-- protocol error"),void process.nextTick(function(){t.drop(f.CLOSE_REASON_PROTOCOL_ERROR,e.dropReason)});if(e.frameTooLarge)return this._debug("-- frame too large"),void process.nextTick(function(){t.drop(f.CLOSE_REASON_MESSAGE_TOO_BIG,e.dropReason)});if(e.rsv1||e.rsv2||e.rsv3)return this._debug("-- illegal rsv flag"),void process.nextTick(function(){t.drop(f.CLOSE_REASON_PROTOCOL_ERROR,"Unsupported usage of rsv bits without negotiated extension.")});this.assembleFragments||(this._debug("-- emitting frame"),process.nextTick(function(){t.emit("frame",e)})),process.nextTick(function(){t.processFrame(e)}),this.currentFrame=new r(this.maskBytes,this.frameHeader,this.config),this.bufferList.length>0&&d(this.receivedDataHandler)}else this._debug("-- insufficient data for frame")}},f.prototype.handleSocketError=function(e){this._debug("handleSocketError: %j",e),"closed"!==this.state?(this.closeReasonCode=f.CLOSE_REASON_ABNORMAL,this.closeDescription="Socket Error: "+e.syscall+" "+e.code,this.connected=!1,this.state="closed",this.fragmentationSize=0,s.eventEmitterListenerCount(this,"error")>0&&this.emit("error",e),this.socket.destroy(e),this._debug.printOutput()):this._debug("  --- Socket 'error' after 'close'")},f.prototype.handleSocketEnd=function(){this._debug("handleSocketEnd: received socket end.  state = %s",this.state),this.receivedEnd=!0,"closed"!==this.state?"peer_requested_close"!==this.state&&"ending"!==this.state&&(this._debug("  --- UNEXPECTED socket end."),this.socket.end()):this._debug("  --- Socket 'end' after 'close'")},f.prototype.handleSocketClose=function(e){this._debug("handleSocketClose: received socket close"),this.socketHadError=e,this.connected=!1,this.state="closed",-1===this.closeReasonCode&&(this.closeReasonCode=f.CLOSE_REASON_ABNORMAL,this.closeDescription="Connection dropped by remote peer."),this.clearCloseTimer(),this.clearKeepaliveTimer(),this.clearGracePeriodTimer(),this.closeEventEmitted||(this.closeEventEmitted=!0,this._debug("-- Emitting WebSocketConnection close event"),this.emit("close",this.closeReasonCode,this.closeDescription))},f.prototype.handleSocketDrain=function(){this._debug("handleSocketDrain: socket drain event"),this.outputBufferFull=!1,this.emit("drain")},f.prototype.handleSocketPause=function(){this._debug("handleSocketPause: socket pause event"),this.inputPaused=!0,this.emit("pause")},f.prototype.handleSocketResume=function(){this._debug("handleSocketResume: socket resume event"),this.inputPaused=!1,this.emit("resume"),this.processReceivedData()},f.prototype.pause=function(){this._debug("pause: pause requested"),this.socket.pause()},f.prototype.resume=function(){this._debug("resume: resume requested"),this.socket.resume()},f.prototype.close=function(e,t){if(this.connected){if(this._debug("close: Initating clean WebSocket close sequence."),"number"!=typeof e&&(e=f.CLOSE_REASON_NORMAL),!m(e))throw new Error("Close code "+e+" is not valid.");"string"!=typeof t&&(t=f.CLOSE_DESCRIPTIONS[e]),this.closeReasonCode=e,this.closeDescription=t,this.setCloseTimer(),this.sendCloseFrame(this.closeReasonCode,this.closeDescription),this.state="ending",this.connected=!1}},f.prototype.drop=function(e,t,i){this._debug("drop"),"number"!=typeof e&&(e=f.CLOSE_REASON_PROTOCOL_ERROR),"string"!=typeof t&&(t=f.CLOSE_DESCRIPTIONS[e]),this._debug("Forcefully dropping connection. skipCloseFrame: %s, code: %d, description: %s",i,e,t),this.closeReasonCode=e,this.closeDescription=t,this.frameQueue=[],this.fragmentationSize=0,i||this.sendCloseFrame(e,t),this.connected=!1,this.state="closed",this.clearCloseTimer(),this.clearKeepaliveTimer(),this.clearGracePeriodTimer(),this.closeEventEmitted||(this.closeEventEmitted=!0,this._debug("Emitting WebSocketConnection close event"),this.emit("close",this.closeReasonCode,this.closeDescription)),this._debug("Drop: destroying socket"),this.socket.destroy()},f.prototype.setCloseTimer=function(){this._debug("setCloseTimer"),this.clearCloseTimer(),this._debug("Setting close timer"),this.waitingForCloseResponse=!0,this.closeTimer=setTimeout(this._closeTimerHandler,this.closeTimeout)},f.prototype.clearCloseTimer=function(){this._debug("clearCloseTimer"),this.closeTimer&&(this._debug("Clearing close timer"),clearTimeout(this.closeTimer),this.waitingForCloseResponse=!1,this.closeTimer=null)},f.prototype.handleCloseTimer=function(){this._debug("handleCloseTimer"),this.closeTimer=null,this.waitingForCloseResponse&&(this._debug("Close response not received from client.  Forcing socket end."),this.waitingForCloseResponse=!1,this.state="closed",this.socket.end())},f.prototype.processFrame=function(e){if(this._debug("processFrame"),this._debug(" -- frame: %s",e),0!==this.frameQueue.length&&e.opcode>0&&e.opcode<8)this.drop(f.CLOSE_REASON_PROTOCOL_ERROR,"Illegal frame opcode 0x"+e.opcode.toString(16)+" received in middle of fragmented message.");else switch(e.opcode){case 2:this._debug("-- Binary Frame"),this.assembleFragments&&(e.fin?(this._debug("---- Emitting 'message' event"),this.emit("message",{type:"binary",binaryData:e.binaryPayload})):(this.frameQueue.push(e),this.fragmentationSize=e.length));break;case 1:if(this._debug("-- Text Frame"),this.assembleFragments)if(e.fin){if(!c.isValidUTF8(e.binaryPayload))return void this.drop(f.CLOSE_REASON_INVALID_DATA,"Invalid UTF-8 Data Received");this._debug("---- Emitting 'message' event"),this.emit("message",{type:"utf8",utf8Data:e.binaryPayload.toString("utf8")})}else this.frameQueue.push(e),this.fragmentationSize=e.length;break;case 0:if(this._debug("-- Continuation Frame"),this.assembleFragments){if(0===this.frameQueue.length)return void this.drop(f.CLOSE_REASON_PROTOCOL_ERROR,"Unexpected Continuation Frame");if(this.fragmentationSize+=e.length,this.fragmentationSize>this.maxReceivedMessageSize)return void this.drop(f.CLOSE_REASON_MESSAGE_TOO_BIG,"Maximum message size exceeded.");if(this.frameQueue.push(e),e.fin){var t=0,i=h(this.fragmentationSize),n=this.frameQueue[0].opcode;switch(this.frameQueue.forEach(function(e){e.binaryPayload.copy(i,t),t+=e.binaryPayload.length}),this.frameQueue=[],this.fragmentationSize=0,n){case 2:this.emit("message",{type:"binary",binaryData:i});break;case 1:if(!c.isValidUTF8(i))return void this.drop(f.CLOSE_REASON_INVALID_DATA,"Invalid UTF-8 Data Received");this.emit("message",{type:"utf8",utf8Data:i.toString("utf8")});break;default:return void this.drop(f.CLOSE_REASON_PROTOCOL_ERROR,"Unexpected first opcode in fragmentation sequence: 0x"+n.toString(16))}}}break;case 9:if(this._debug("-- Ping Frame"),this._pingListenerCount>0){var s=!1;this.emit("ping",function(){s=!0},e.binaryPayload),s||this.pong(e.binaryPayload)}else this.pong(e.binaryPayload);break;case 10:this._debug("-- Pong Frame"),this.emit("pong",e.binaryPayload);break;case 8:if(this._debug("-- Close Frame"),this.waitingForCloseResponse)return this._debug("---- Got close response from peer.  Completing closing handshake."),this.clearCloseTimer(),this.waitingForCloseResponse=!1,this.state="closed",void this.socket.end();var o;if(this._debug("---- Closing handshake initiated by peer."),this.state="peer_requested_close",e.invalidCloseFrameLength?(this.closeReasonCode=1005,o=f.CLOSE_REASON_PROTOCOL_ERROR):-1===e.closeStatus||m(e.closeStatus)?(this.closeReasonCode=e.closeStatus,o=f.CLOSE_REASON_NORMAL):(this.closeReasonCode=e.closeStatus,o=f.CLOSE_REASON_PROTOCOL_ERROR),e.binaryPayload.length>1){if(!c.isValidUTF8(e.binaryPayload))return void this.drop(f.CLOSE_REASON_INVALID_DATA,"Invalid UTF-8 Data Received");this.closeDescription=e.binaryPayload.toString("utf8")}else this.closeDescription=f.CLOSE_DESCRIPTIONS[this.closeReasonCode];this._debug("------ Remote peer %s - code: %d - %s - close frame payload length: %d",this.remoteAddress,this.closeReasonCode,this.closeDescription,e.length),this._debug("------ responding to remote peer's close request."),this.sendCloseFrame(o,null),this.connected=!1;break;default:this._debug("-- Unrecognized Opcode %d",e.opcode),this.drop(f.CLOSE_REASON_PROTOCOL_ERROR,"Unrecognized Opcode: 0x"+e.opcode.toString(16))}},f.prototype.send=function(e,t){if(this._debug("send"),Buffer.isBuffer(e))this.sendBytes(e,t);else{if("function"!=typeof e.toString)throw new Error("Data provided must either be a Node Buffer or implement toString()");this.sendUTF(e,t)}},f.prototype.sendUTF=function(e,t){e=u(e.toString(),"utf8"),this._debug("sendUTF: %d bytes",e.length);var i=new r(this.maskBytes,this.frameHeader,this.config);i.opcode=1,i.binaryPayload=e,this.fragmentAndSend(i,t)},f.prototype.sendBytes=function(e,t){if(this._debug("sendBytes"),!Buffer.isBuffer(e))throw new Error("You must pass a Node Buffer object to WebSocketConnection.prototype.sendBytes()");var i=new r(this.maskBytes,this.frameHeader,this.config);i.opcode=2,i.binaryPayload=e,this.fragmentAndSend(i,t)},f.prototype.ping=function(e){this._debug("ping");var t=new r(this.maskBytes,this.frameHeader,this.config);t.opcode=9,t.fin=!0,e&&(Buffer.isBuffer(e)||(e=u(e.toString(),"utf8")),e.length>125&&(this._debug("WebSocket: Data for ping is longer than 125 bytes.  Truncating."),e=e.slice(0,124)),t.binaryPayload=e),this.sendFrame(t)},f.prototype.pong=function(e){this._debug("pong");var t=new r(this.maskBytes,this.frameHeader,this.config);t.opcode=10,Buffer.isBuffer(e)&&e.length>125&&(this._debug("WebSocket: Data for pong is longer than 125 bytes.  Truncating."),e=e.slice(0,124)),t.binaryPayload=e,t.fin=!0,this.sendFrame(t)},f.prototype.fragmentAndSend=function(e,t){if(this._debug("fragmentAndSend"),e.opcode>7)throw new Error("You cannot fragment control frames.");var i=this.config.fragmentationThreshold,n=e.binaryPayload.length;if(!this.config.fragmentOutgoingMessages||e.binaryPayload&&n<=i)return e.fin=!0,void this.sendFrame(e,t);for(var s=Math.ceil(n/i),o=0,a=function(e){e?"function"==typeof t&&(t(e),t=null):++o===s&&"function"==typeof t&&t()},c=1;c<=s;c++){var h=new r(this.maskBytes,this.frameHeader,this.config);h.opcode=1===c?e.opcode:0,h.fin=c===s;var u=c===s?n-i*(c-1):i,l=i*(c-1);h.binaryPayload=e.binaryPayload.slice(l,l+u),this.sendFrame(h,a)}},f.prototype.sendCloseFrame=function(e,t,i){if("number"!=typeof e&&(e=f.CLOSE_REASON_NORMAL),this._debug("sendCloseFrame state: %s, reasonCode: %d, description: %s",this.state,e,t),this.state===l||"peer_requested_close"===this.state){var n=new r(this.maskBytes,this.frameHeader,this.config);n.fin=!0,n.opcode=8,n.closeStatus=e,"string"==typeof t&&(n.binaryPayload=u(t,"utf8")),this.sendFrame(n,i),this.socket.end()}},f.prototype.sendFrame=function(e,t){this._debug("sendFrame"),e.mask=this.maskOutgoingPackets;var i=this.socket.write(e.toBuffer(),t);return this.outputBufferFull=!i,i},e.exports=f},function(e,t,i){"undefined"!=typeof process&&"renderer"===process.type?e.exports=i(17):e.exports=i(19)},function(e,t,i){var n;function s(e){function i(){if(i.enabled){var e=i,s=+new Date,o=s-(n||s);e.diff=o,e.prev=n,e.curr=s,n=s;for(var r=new Array(arguments.length),a=0;a<r.length;a++)r[a]=arguments[a];r[0]=t.coerce(r[0]),"string"!=typeof r[0]&&r.unshift("%O");var c=0;r[0]=r[0].replace(/%([a-zA-Z%])/g,function(i,n){if("%%"===i)return i;c++;var s=t.formatters[n];if("function"==typeof s){var o=r[c];i=s.call(e,o),r.splice(c,1),c--}return i}),t.formatArgs.call(e,r),(i.log||t.log||console.log.bind(console)).apply(e,r)}}return i.namespace=e,i.enabled=t.enabled(e),i.useColors=t.useColors(),i.color=function(e){var i,n=0;for(i in e)n=(n<<5)-n+e.charCodeAt(i),n|=0;return t.colors[Math.abs(n)%t.colors.length]}(e),"function"==typeof t.init&&t.init(i),i}(t=e.exports=s.debug=s.default=s).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e),t.names=[],t.skips=[];for(var i=("string"==typeof e?e:"").split(/[\s,]+/),n=i.length,s=0;s<n;s++)i[s]&&("-"===(e=i[s].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var i,n;for(i=0,n=t.skips.length;i<n;i++)if(t.skips[i].test(e))return!1;for(i=0,n=t.names.length;i<n;i++)if(t.names[i].test(e))return!0;return!1},t.humanize=i(18),t.names=[],t.skips=[],t.formatters={}},function(e,t,i){for(var n=i(3),s=i(0),o=i(4),r=i(1).EventEmitter,a=i(5),c=/,\s*/,h=/;\s*/,u=/[\r\n]/g,l=/,\s*/,d=["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," ",String.fromCharCode(9)],p=[String.fromCharCode(127)],f=0;f<31;f++)p.push(String.fromCharCode(f));var m=/([\x00-\x20\x22\x28\x29\x2c\x2f\x3a-\x3f\x40\x5b-\x5e\x7b\x7d\x7f])/,g=/[^\x21\x23-\x2b\x2d-\x3a\x3c-\x5b\x5d-\x7e]/,v=/^"[^"]*"$/,b=/[\x00-\x20\x3b]/g,y=/[;,] */,S={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",406:"Not Acceptable",407:"Proxy Authorization Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Long",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",426:"Upgrade Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};function _(e,t,i){r.call(this),this.socket=e,this.httpRequest=t,this.resource=t.url,this.remoteAddress=e.remoteAddress,this.remoteAddresses=[this.remoteAddress],this.serverConfig=i,this._socketIsClosing=!1,this._socketCloseHandler=this._handleSocketCloseBeforeAccept.bind(this),this.socket.on("end",this._socketCloseHandler),this.socket.on("close",this._socketCloseHandler),this._resolved=!1}function E(e){process.nextTick(function(){e.drop(1006,"TCP connection lost before handshake completed.",!0)})}s.inherits(_,r),_.prototype.readHandshake=function(){var e=this,t=this.httpRequest;if(this.resourceURL=o.parse(this.resource,!0),this.host=t.headers.host,!this.host)throw new Error("Client must provide a Host header.");if(this.key=t.headers["sec-websocket-key"],!this.key)throw new Error("Client must provide a value for Sec-WebSocket-Key.");if(this.webSocketVersion=parseInt(t.headers["sec-websocket-version"],10),!this.webSocketVersion||isNaN(this.webSocketVersion))throw new Error("Client must provide a value for Sec-WebSocket-Version.");switch(this.webSocketVersion){case 8:case 13:break;default:var i=new Error("Unsupported websocket client version: "+this.webSocketVersion+"Only versions 8 and 13 are supported.");throw i.httpCode=426,i.headers={"Sec-WebSocket-Version":"13"},i}13===this.webSocketVersion?this.origin=t.headers.origin:8===this.webSocketVersion&&(this.origin=t.headers["sec-websocket-origin"]);var n=t.headers["sec-websocket-protocol"];(this.protocolFullCaseMap={},this.requestedProtocols=[],n)&&n.split(c).forEach(function(t){var i=t.toLocaleLowerCase();e.requestedProtocols.push(i),e.protocolFullCaseMap[i]=t});if(!this.serverConfig.ignoreXForwardedFor&&t.headers["x-forwarded-for"]){var s=this.remoteAddress;this.remoteAddresses=t.headers["x-forwarded-for"].split(l),this.remoteAddresses.push(s),this.remoteAddress=this.remoteAddresses[0]}var r=t.headers["sec-websocket-extensions"];this.requestedExtensions=this.parseExtensions(r);var a=t.headers.cookie;this.cookies=this.parseCookies(a)},_.prototype.parseExtensions=function(e){if(!e||0===e.length)return[];var t=e.toLocaleLowerCase().split(c);return t.forEach(function(e,t,i){var n=e.split(h),s=n[0],o=n.slice(1);o.forEach(function(e,t,i){var n=e.split("="),s={name:n[0],value:n[1]};i.splice(t,1,s)});var r={name:s,params:o};i.splice(t,1,r)}),t},_.prototype.parseCookies=function(e){if(!e||"string"!=typeof e)return[];var t=[];return e.split(y).forEach(function(e){var i=e.indexOf("=");if(-1!==i){var n=e.substr(0,i).trim(),s=e.substr(++i,e.length).trim();'"'===s[0]&&(s=s.slice(1,-1)),t.push({name:n,value:decodeURIComponent(s)})}else t.push({name:e,value:null})}),t},_.prototype.accept=function(e,t,i){var s;this._verifyResolution(),e?void 0===(s=this.protocolFullCaseMap[e.toLocaleLowerCase()])&&(s=e):s=e,this.protocolFullCaseMap=null;var o=n.createHash("sha1");o.update(this.key+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");var r="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: "+o.digest("base64")+"\r\n";if(s){for(var c=0;c<s.length;c++){var h=s.charCodeAt(c),l=s.charAt(c);if(h<33||h>126||-1!==d.indexOf(l))throw this.reject(500),new Error('Illegal character "'+String.fromCharCode(l)+'" in subprotocol.')}if(-1===this.requestedProtocols.indexOf(e))throw this.reject(500),new Error("Specified protocol was not requested by the client.");s=s.replace(u,""),r+="Sec-WebSocket-Protocol: "+s+"\r\n"}if(this.requestedProtocols=null,t&&(t=t.replace(u,""),13===this.webSocketVersion?r+="Origin: "+t+"\r\n":8===this.webSocketVersion&&(r+="Sec-WebSocket-Origin: "+t+"\r\n")),i){if(!Array.isArray(i))throw this.reject(500),new Error('Value supplied for "cookies" argument must be an array.');var p={};i.forEach(function(e){if(!e.name||!e.value)throw this.reject(500),new Error('Each cookie to set must at least provide a "name" and "value"');if(e.name=e.name.replace(b,""),e.value=e.value.replace(b,""),p[e.name])throw this.reject(500),new Error("You may not specify the same cookie name twice.");p[e.name]=!0;var t=e.name.match(m);if(t)throw this.reject(500),new Error("Illegal character "+t[0]+" in cookie name");if(t=e.value.match(v)?e.value.slice(1,-1).match(g):e.value.match(g))throw this.reject(500),new Error("Illegal character "+t[0]+" in cookie value");var i=[e.name+"="+e.value];if(e.path){if(t=e.path.match(b))throw this.reject(500),new Error("Illegal character "+t[0]+" in cookie path");i.push("Path="+e.path)}if(e.domain){if("string"!=typeof e.domain)throw this.reject(500),new Error("Domain must be specified and must be a string.");if(t=e.domain.match(b))throw this.reject(500),new Error("Illegal character "+t[0]+" in cookie domain");i.push("Domain="+e.domain.toLowerCase())}if(e.expires){if(!(e.expires instanceof Date))throw this.reject(500),new Error('Value supplied for cookie "expires" must be a vaild date object');i.push("Expires="+e.expires.toGMTString())}if(e.maxage){var n=e.maxage;if("string"==typeof n&&(n=parseInt(n,10)),isNaN(n)||n<=0)throw this.reject(500),new Error('Value supplied for cookie "maxage" must be a non-zero number');n=Math.round(n),i.push("Max-Age="+n.toString(10))}if(e.secure){if("boolean"!=typeof e.secure)throw this.reject(500),new Error('Value supplied for cookie "secure" must be of type boolean');i.push("Secure")}if(e.httponly){if("boolean"!=typeof e.httponly)throw this.reject(500),new Error('Value supplied for cookie "httponly" must be of type boolean');i.push("HttpOnly")}r+="Set-Cookie: "+i.join(";")+"\r\n"}.bind(this))}this._resolved=!0,this.emit("requestResolved",this),r+="\r\n";var f=new a(this.socket,[],e,!1,this.serverConfig);f.webSocketVersion=this.webSocketVersion,f.remoteAddress=this.remoteAddress,f.remoteAddresses=this.remoteAddresses;var y=this;return this._socketIsClosing?E(f):this.socket.write(r,"ascii",function(e){e?E(f):(y._removeSocketCloseListeners(),f._addSocketEventListeners())}),this.emit("requestAccepted",f),f},_.prototype.reject=function(e,t,i){this._verifyResolution(),this._resolved=!0,this.emit("requestResolved",this),"number"!=typeof e&&(e=403);var n="HTTP/1.1 "+e+" "+S[e]+"\r\nConnection: close\r\n";if(t&&(n+="X-WebSocket-Reject-Reason: "+(t=t.replace(u,""))+"\r\n"),i)for(var s in i){var o=i[s].toString().replace(u,"");n+=s.replace(u,"")+": "+o+"\r\n"}n+="\r\n",this.socket.end(n,"ascii"),this.emit("requestRejected",this)},_.prototype._handleSocketCloseBeforeAccept=function(){this._socketIsClosing=!0,this._removeSocketCloseListeners()},_.prototype._removeSocketCloseListeners=function(){this.socket.removeListener("end",this._socketCloseHandler),this.socket.removeListener("close",this._socketCloseHandler)},_.prototype._verifyResolution=function(){if(this._resolved)throw new Error("WebSocketRequest may only be accepted or rejected one time.")},e.exports=_},function(e,t,i){var n=i(23).BufferUtil,s=i(2).bufferAllocUnsafe;const o=1;function r(e,t,i){this.maskBytes=e,this.frameHeader=t,this.config=i,this.maxReceivedFrameSize=i.maxReceivedFrameSize,this.protocolError=!1,this.frameTooLarge=!1,this.invalidCloseFrameLength=!1,this.parseState=o,this.closeStatus=-1}r.prototype.addData=function(e){if(this.parseState===o&&e.length>=2){e.joinInto(this.frameHeader,0,0,2),e.advance(2);var t=this.frameHeader[0],i=this.frameHeader[1];if(this.fin=Boolean(128&t),this.rsv1=Boolean(64&t),this.rsv2=Boolean(32&t),this.rsv3=Boolean(16&t),this.mask=Boolean(128&i),this.opcode=15&t,this.length=127&i,this.opcode>=8){if(this.length>125)return this.protocolError=!0,this.dropReason="Illegal control frame longer than 125 bytes.",!0;if(!this.fin)return this.protocolError=!0,this.dropReason="Control frames must not be fragmented.",!0}126===this.length?this.parseState=2:127===this.length?this.parseState=3:this.parseState=4}if(2===this.parseState)e.length>=2&&(e.joinInto(this.frameHeader,2,0,2),e.advance(2),this.length=this.frameHeader.readUInt16BE(2),this.parseState=4);else if(3===this.parseState&&e.length>=8){e.joinInto(this.frameHeader,2,0,8),e.advance(8);var r=[this.frameHeader.readUInt32BE(2),this.frameHeader.readUInt32BE(6)];if(0!==r[0])return this.protocolError=!0,this.dropReason="Unsupported 64-bit length frame received",!0;this.length=r[1],this.parseState=4}if(4===this.parseState&&(this.mask?e.length>=4&&(e.joinInto(this.maskBytes,0,0,4),e.advance(4),this.parseState=5):this.parseState=5),5===this.parseState){if(this.length>this.maxReceivedFrameSize)return this.frameTooLarge=!0,this.dropReason="Frame size of "+this.length.toString(10)+" bytes exceeds maximum accepted frame size",!0;if(0===this.length)return this.binaryPayload=s(0),this.parseState=6,!0;if(e.length>=this.length)return this.binaryPayload=e.take(this.length),e.advance(this.length),this.mask&&n.unmask(this.binaryPayload,this.maskBytes),8===this.opcode&&(1===this.length&&(this.binaryPayload=s(0),this.invalidCloseFrameLength=!0),this.length>=2&&(this.closeStatus=this.binaryPayload.readUInt16BE(0),this.binaryPayload=this.binaryPayload.slice(2))),this.parseState=6,!0}return!1},r.prototype.throwAwayPayload=function(e){return e.length>=this.length&&(e.advance(this.length),this.parseState=6,!0)},r.prototype.toBuffer=function(e){var t,i,o,r=2,a=0,c=0;this.fin&&(a|=128),this.rsv1&&(a|=64),this.rsv2&&(a|=32),this.rsv3&&(a|=16),this.mask&&(c|=128),a|=15&this.opcode,8===this.opcode?(this.length=2,this.binaryPayload&&(this.length+=this.binaryPayload.length),(i=s(this.length)).writeUInt16BE(this.closeStatus,0),this.length>2&&this.binaryPayload.copy(i,2)):this.binaryPayload?(i=this.binaryPayload,this.length=i.length):this.length=0,this.length<=125?c|=127&this.length:this.length>125&&this.length<=65535?(c|=126,r+=2):this.length>65535&&(c|=127,r+=8);var h=s(this.length+r+(this.mask?4:0));return h[0]=a,h[1]=c,o=2,this.length>125&&this.length<=65535?(h.writeUInt16BE(this.length,o),o+=2):this.length>65535&&(h.writeUInt32BE(0,o),h.writeUInt32BE(this.length,o+4),o+=8),this.mask?(t=e?0:4294967295*Math.random()>>>0,this.maskBytes.writeUInt32BE(t,0),this.maskBytes.copy(h,o),o+=4,i&&n.mask(i,this.maskBytes,h,o,this.length)):i&&i.copy(h,o),h},r.prototype.toString=function(){return"Opcode: "+this.opcode+", fin: "+this.fin+", length: "+this.length+", hasPayload: "+Boolean(this.binaryPayload)+", masked: "+this.mask},e.exports=r},function(e,t,i){var n=i(2),s=n.extend,o=i(0),r=i(1).EventEmitter,a=i(29),c=i(30),h=i(4),u=i(3),l=i(5),d=n.bufferAllocUnsafe,p=["(",")","<",">","@",",",";",":","\\",'"',"/","[","]","?","=","{","}"," ",String.fromCharCode(9)],f=["hostname","port","method","path","headers"];function m(e){var t;(r.call(this),this.config={maxReceivedFrameSize:1048576,maxReceivedMessageSize:8388608,fragmentOutgoingMessages:!0,fragmentationThreshold:16384,webSocketVersion:13,assembleFragments:!0,disableNagleAlgorithm:!0,closeTimeout:5e3,tlsOptions:{}},e)&&(e.tlsOptions?(t=e.tlsOptions,delete e.tlsOptions):t={},s(this.config,e),s(this.config.tlsOptions,t));switch(this._req=null,this.config.webSocketVersion){case 8:case 13:break;default:throw new Error("Requested webSocketVersion is not supported. Allowed values are 8 and 13.")}}o.inherits(m,r),m.prototype.connect=function(e,t,i,o,r){var u=this;if("string"==typeof t&&(t=t.length>0?[t]:[]),t instanceof Array||(t=[]),this.protocols=t,this.origin=i,this.url="string"==typeof e?h.parse(e):e,!this.url.protocol)throw new Error("You must specify a full WebSocket URL, including protocol.");if(!this.url.host)throw new Error("You must specify a full WebSocket URL, including hostname. Relative URLs are not supported.");this.secure="wss:"===this.url.protocol,this.protocols.forEach(function(e){for(var t=0;t<e.length;t++){var i=e.charCodeAt(t),n=e.charAt(t);if(i<33||i>126||-1!==p.indexOf(n))throw new Error('Protocol list contains invalid character "'+String.fromCharCode(i)+'"')}});this.url.port||(this.url.port={"ws:":"80","wss:":"443"}[this.url.protocol]);for(var l=d(16),m=0;m<16;m++)l[m]=Math.round(255*Math.random());this.base64nonce=l.toString("base64");var g=this.url.hostname;("ws:"===this.url.protocol&&"80"!==this.url.port||"wss:"===this.url.protocol&&"443"!==this.url.port)&&(g+=":"+this.url.port);var v,b={};function y(e){u._req=null,u.emit("connectFailed",e)}this.secure&&this.config.tlsOptions.hasOwnProperty("headers")&&s(b,this.config.tlsOptions.headers),o&&s(b,o),s(b,{Upgrade:"websocket",Connection:"Upgrade","Sec-WebSocket-Version":this.config.webSocketVersion.toString(10),"Sec-WebSocket-Key":this.base64nonce,Host:b.Host||g}),this.protocols.length>0&&(b["Sec-WebSocket-Protocol"]=this.protocols.join(", ")),this.origin&&(13===this.config.webSocketVersion?b.Origin=this.origin:8===this.config.webSocketVersion&&(b["Sec-WebSocket-Origin"]=this.origin)),v=this.url.pathname?this.url.path:this.url.path?"/"+this.url.path:"/";var S={agent:!1};if(r&&s(S,r),s(S,{hostname:this.url.hostname,port:this.url.port,method:"GET",path:v,headers:b}),this.secure){var _=this.config.tlsOptions;for(var E in _)_.hasOwnProperty(E)&&-1===f.indexOf(E)&&(S[E]=_[E])}var k=this._req=(this.secure?c:a).request(S);k.on("upgrade",function(e,t,i){u._req=null,k.removeListener("error",y),u.socket=t,u.response=e,u.firstDataChunk=i,u.validateHandshake()}),k.on("error",y),k.on("response",function(e){if(u._req=null,n.eventEmitterListenerCount(u,"httpResponse")>0)u.emit("httpResponse",e,u),e.socket&&e.socket.end();else{var t=[];for(var i in e.headers)t.push(i+": "+e.headers[i]);u.failHandshake("Server responded with a non-101 status: "+e.statusCode+" "+e.statusMessage+"\nResponse Headers Follow:\n"+t.join("\n")+"\n")}}),k.end()},m.prototype.validateHandshake=function(){var e=this.response.headers;if(this.protocols.length>0){if(this.protocol=e["sec-websocket-protocol"],!this.protocol)return void this.failHandshake("Expected a Sec-WebSocket-Protocol header.");if(-1===this.protocols.indexOf(this.protocol))return void this.failHandshake("Server did not respond with a requested protocol.")}if(e.connection&&"upgrade"===e.connection.toLocaleLowerCase())if(e.upgrade&&"websocket"===e.upgrade.toLocaleLowerCase()){var t=u.createHash("sha1");t.update(this.base64nonce+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11");var i=t.digest("base64");e["sec-websocket-accept"]?e["sec-websocket-accept"]===i?this.succeedHandshake():this.failHandshake("Sec-WebSocket-Accept header from server didn't match expected value of "+i):this.failHandshake("Expected Sec-WebSocket-Accept header from server")}else this.failHandshake("Expected an Upgrade: websocket header from the server");else this.failHandshake("Expected a Connection: Upgrade header from the server")},m.prototype.failHandshake=function(e){this.socket&&this.socket.writable&&this.socket.end(),this.emit("connectFailed",new Error(e))},m.prototype.succeedHandshake=function(){var e=new l(this.socket,[],this.protocol,!0,this.config);e.webSocketVersion=this.config.webSocketVersion,e._addSocketEventListeners(),this.emit("connect",e),this.firstDataChunk.length>0&&e.handleSocketData(this.firstDataChunk),this.firstDataChunk=null},m.prototype.abort=function(){this._req&&this._req.abort()},e.exports=m},function(e,t,i){"use strict";var n=i(12),s=i(42),o=i(4),r=i(0),a=i(1),c=i(43),h=/^MSG\s+([^\s\r\n]+)\s+([^\s\r\n]+)\s+(([^\s\r\n]+)[^\S\r\n]+)?(\d+)\r\n/i,u=/^\+OK\s*\r\n/i,l=/^-ERR\s+('.+')?\r\n/i,d=/^PING\r\n/i,p=/^PONG\r\n/i,f=/^INFO\s+([^\r\n]+)\r\n/i,m=/^SUB\s+([^\r\n]+)\r\n/i,g="\r\n",v=g.length;function b(e,t,i){Error.captureStackTrace(this,this.constructor),this.name=this.constructor.name,this.message=e,this.code=t,this.chainedError=i}r.inherits(b,Error),t.NatsError=b,t.version="1.0.1",t.BAD_SUBJECT="BAD_SUBJECT",t.BAD_MSG="BAD_MSG",t.BAD_REPLY="BAD_REPLY",t.CONN_CLOSED="CONN_CLOSED",t.BAD_JSON="BAD_JSON",t.BAD_AUTHENTICATION="BAD_AUTHENTICATION",t.INVALID_ENCODING="INVALID_ENCODING",t.SECURE_CONN_REQ="SECURE_CONN_REQ",t.NON_SECURE_CONN_REQ="NON_SECURE_CONN_REQ",t.CLIENT_CERT_REQ="CLIENT_CERT_REQ",t.NATS_PROTOCOL_ERR="NATS_PROTOCOL_ERR",t.REQ_TIMEOUT="REQ_TIMEOUT";var y=t.createInbox=function(){return"_INBOX."+c.next()};function S(e){a.EventEmitter.call(this),this.parseOptions(e),this.initState(),this.createConnection()}function _(e){for(var t=e.length-1;t>0;t--){var i=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[i],e[i]=n}return e}function E(e){this.url=e,this.didConnect=!1,this.reconnects=0}t.connect=function(e){return new S(e)},r.inherits(S,a.EventEmitter),S.prototype.createInbox=y,S.prototype.assignOption=function(e,t,i){void 0===i&&(i=t),void 0!==e[t]&&(this.options[i]=e[t])},S.prototype.parseOptions=function(e){var t=this.options={verbose:!1,pedantic:!1,reconnect:!0,maxReconnectAttempts:10,reconnectTimeWait:2e3,encoding:"utf8",tls:!1,waitOnFirstConnect:!1,pingInterval:12e4,maxPingOut:2,useOldRequestStyle:!1};void 0===e?t.url="nats://localhost:4222":"number"==typeof e?t.url="nats://localhost:"+e:"string"==typeof e?t.url=e:"object"==typeof e&&(void 0!==e.port&&(t.url="nats://localhost:"+e.port),this.assignOption(e,"url"),this.assignOption(e,"uri","url"),this.assignOption(e,"user"),this.assignOption(e,"pass"),this.assignOption(e,"token"),this.assignOption(e,"password","pass"),this.assignOption(e,"verbose"),this.assignOption(e,"pedantic"),this.assignOption(e,"reconnect"),this.assignOption(e,"maxReconnectAttempts"),this.assignOption(e,"reconnectTimeWait"),this.assignOption(e,"servers"),this.assignOption(e,"urls","servers"),this.assignOption(e,"noRandomize"),this.assignOption(e,"NoRandomize","noRandomize"),this.assignOption(e,"dontRandomize","noRandomize"),this.assignOption(e,"encoding"),this.assignOption(e,"tls"),this.assignOption(e,"secure","tls"),this.assignOption(e,"name"),this.assignOption(e,"client","name"),this.assignOption(e,"yieldTime"),this.assignOption(e,"waitOnFirstConnect"),this.assignOption(e,"json"),this.assignOption(e,"preserveBuffers"),this.assignOption(e,"pingInterval"),this.assignOption(e,"maxPingOut"),this.assignOption(e,"useOldRequestStyle"));var i=this;if(i.user=t.user,i.pass=t.pass,i.token=t.token,i.user&&i.token)throw new b("User and Token can not both be provided","BAD_AUTHENTICATION");if(!Buffer.isEncoding(t.encoding))throw new b("Invalid Encoding:"+t.encoding,"INVALID_ENCODING");i.encoding=t.encoding,i.servers=[],Array.isArray(t.servers)?(t.servers.forEach(function(e){i.servers.push(new E(o.parse(e)))}),!0!==t.noRandomize&&_(i.servers),void 0!==t.url&&-1===i.servers.indexOf(t.url)&&i.servers.unshift(new E(o.parse(t.url)))):(void 0===t.url&&(t.url="nats://localhost:4222"),i.servers.push(new E(o.parse(t.url))))},E.prototype.toString=function(){return this.url.href},S.prototype.selectServer=function(){var e=this.servers.shift();if(this.currentServer=e,this.url=e.url,"auth"in e.url&&e.url.auth){var t=e.url.auth.split(":");1!==t.length?(void 0===this.options.user&&(this.user=t[0]),void 0===this.options.pass&&(this.pass=t[1])):void 0===this.options.token&&(this.token=t[0])}this.servers.push(e)},S.prototype.checkTLSMismatch=function(){return!0===this.info.tls_required&&!1===this.options.tls?(this.emit("error",new b("Server requires a secure connection.","SECURE_CONN_REQ")),this.closeStream(),!0):this.info.tls_required||!1===this.options.tls?!0===this.info.tls_verify&&void 0===this.options.tls.cert&&(this.emit("error",new b("Server requires a client certificate.","CLIENT_CERT_REQ")),this.closeStream(),!0):(this.emit("error",new b("Server does not support a secure connection.","NON_SECURE_CONN_REQ")),this.closeStream(),!0)},S.prototype.connectCB=function(){var e=!0===this.reconnecting?"reconnect":"connect";this.reconnecting=!1,this.reconnects=0,this.wasConnected=!0,this.currentServer.didConnect=!0,this.emit(e,this),this.flushPending()},S.prototype.scheduleHeartbeat=function(){this.pingTimer=setTimeout(function(e){if(e.emit("pingtimer"),!e.closed){if(e.stream&&!e.stream.connecting){if(e.emit("pingcount",e.pout),e.pout++,e.pout>e.options.maxPingOut)return void e.processErr("stale connection");e.sendCommand("PING\r\n"),e.pongs&&e.pongs.push(void 0)}e.scheduleHeartbeat()}},this.options.pingInterval,this)},S.prototype.setupHandlers=function(){var e=this,t=e.stream;void 0!==t&&(t.on("connect",function(){e.pingTimer&&(clearTimeout(e.pingTimer),delete e.pingTimer),e.connected=!0,e.scheduleHeartbeat()}),t.on("close",function(t){e.closeStream(),e.emit("disconnect"),!0===e.closed||!1===e.options.reconnect||e.reconnects>=e.options.maxReconnectAttempts&&-1!==e.options.maxReconnectAttempts?e.emit("close"):e.scheduleReconnect()}),t.on("error",function(t){!0===e.wasConnected&&!0===e.currentServer.didConnect||(!1===e.wasConnected&&!1===e.currentServer.didConnect&&(e.options.waitOnFirstConnect?e.currentServer.didConnect=!0:e.servers.splice(e.servers.length-1,1)),!1===e.wasConnected&&0===e.servers.length&&e.emit("error",new b("Could not connect to server: "+t,"CONN_ERR",t)),e.closeStream())}),t.on("data",function(t){e.inbound?e.inbound=Buffer.concat([e.inbound,t]):e.inbound=t,e.processInbound()}))},S.prototype.sendConnect=function(){var e={lang:"node",version:"1.0.1",verbose:this.options.verbose,pedantic:this.options.pedantic,protocol:1};void 0!==this.user&&(e.user=this.user,e.pass=this.pass),void 0!==this.token&&(e.auth_token=this.token),void 0!==this.options.name&&(e.name=this.options.name),this.stream.write("CONNECT "+JSON.stringify(e)+g)},S.prototype.createConnection=function(){var e=[],t=[],i=0,s=this;if(null!==s.pending){var o=0;s.pending.forEach(function(n){var r=Buffer.isBuffer(n)?n.length:Buffer.byteLength(n);if("PING\r\n"===n&&null!==s.pongs&&o<s.pongs.length){var a=s.pongs[o++];void 0!==a&&(t.push(n),i+=r,e.push(a))}else n.length>3&&"P"===n[0]&&"U"===n[1]&&"B"===n[2]&&(t.push(n),i+=r)})}this.pongs=e,this.pending=t,this.pSize=i,this.pstate=0,this.info=null,this.infoReceived=!1,this.selectServer(),this.stream&&(this.stream.removeAllListeners(),this.stream.destroy()),this.stream=n.createConnection(this.url),this.setupHandlers()},S.prototype.initState=function(){this.ssid=1,this.subs={},this.reconnects=0,this.connected=!1,this.wasConnected=!1,this.reconnecting=!1,this.server=null,this.pending=[],this.pout=0},S.prototype.close=function(){this.pingTimer&&(clearTimeout(this.pingTimer),delete this.pingTimer),this.closed=!0,this.removeAllListeners(),this.closeStream(),this.ssid=-1,this.subs=null,this.pstate=-1,this.pongs=null,this.pending=null,this.pSize=0},S.prototype.closeStream=function(){null!==this.stream&&(this.stream.destroy(),this.stream=null),!0!==this.connected&&!0!==this.closed||(this.pongs=null,this.pout=0,this.pending=null,this.pSize=0,this.connected=!1),this.inbound=null},S.prototype.flushPending=function(){if(!1!==this.connected&&null!==this.pending&&0!==this.pending.length&&!0===this.infoReceived){var e=this,t=function(t){return e.pending=[],e.pSize=0,e.stream.write(t)};if(this.pBufs){for(var i=!0,n=0;n<this.pending.length;n++)if(!Buffer.isBuffer(this.pending[n])){i=!1;break}if(i)return t(Buffer.concat(this.pending,this.pSize));var s=this.pending;this.pending=[],this.pSize=0;var o=!0;for(n=0;n<s.length;n++)o=this.stream.write(s[n])&&o;return o}return t(this.pending.join(""))}},S.prototype.stripPendingSubs=function(){var e=this.pending;this.pending=[],this.pSize=0;for(var t=0;t<e.length;t++)m.test(e[t])||this.sendCommand(e[t])},S.prototype.sendCommand=function(e){if(!this.closed&&null!==this.pending&&(this.pending.push(e),Buffer.isBuffer(e)?(this.pSize+=e.length,this.pBufs=!0):this.pSize+=Buffer.byteLength(e),!0===this.connected))if(1===this.pending.length){var t=this;setImmediate(function(){t.flushPending()})}else this.pSize>65536&&this.flushPending()},S.prototype.sendSubscriptions=function(){var e="";for(var t in this.subs)if(this.subs.hasOwnProperty(t)){var i=this.subs[t];e+=(i.qgroup?["SUB",i.subject,i.qgroup,t+g]:["SUB",i.subject,t+g]).join(" ")}e.length>0&&this.stream.write(e)},S.prototype.processInbound=function(){var e,t,i=this;if(i.stream)for(i.stream.resume(),void 0!==i.options.yieldTime&&(t=Date.now());!i.closed&&i.inbound&&i.inbound.length>0;){switch(i.pstate){case 0:var n=i.inbound.toString("binary",0,1024);if(null!==(e=h.exec(n)))i.payload={subj:e[1],sid:parseInt(e[2],10),reply:e[4],size:parseInt(e[5],10)},i.payload.psize=i.payload.size+v,i.pstate=1;else if(null!==(e=u.exec(n)));else{if(null!==(e=l.exec(n)))return void i.processErr(e[1]);if(null!==(e=p.exec(n))){i.pout=0;var o=i.pongs&&i.pongs.shift();o&&o()}else if(null!==(e=d.exec(n)))i.sendCommand("PONG\r\n");else{if(null===(e=f.exec(n)))return;if(i.info=JSON.parse(e[1]),!0===i.checkTLSMismatch())return;if(i.processServerUpdate(),!1===i.infoReceived){if(!1!==i.options.tls&&!0!==i.stream.encrypted){var r={socket:i.stream};if("object"==typeof i.options.tls)for(var a in i.options.tls)r[a]=i.options.tls[a];i.stream&&i.stream.removeAllListeners(),i.stream=s.connect(r,function(){i.flushPending()}),i.setupHandlers()}i.sendConnect(),i.sendSubscriptions(),i.pongs.unshift(function(){i.connectCB()}),i.stream.write("PING\r\n"),i.infoReceived=!0,i.stripPendingSubs(),i.flushPending()}}}break;case 1:if(i.inbound.length<i.payload.psize)return void 0===i.payload.chunks&&(i.payload.chunks=[]),i.payload.chunks.push(i.inbound),i.payload.psize-=i.inbound.length,void(i.inbound=null);if(i.payload.chunks){i.payload.chunks.push(i.inbound.slice(0,i.payload.psize));var c=Buffer.concat(i.payload.chunks,i.payload.size);i.options.preserveBuffers?i.payload.msg=c:i.payload.msg=c.toString(i.encoding)}else i.options.preserveBuffers?i.payload.msg=i.inbound.slice(0,i.payload.size):i.payload.msg=i.inbound.toString(i.encoding,0,i.payload.size);if(i.inbound.length===i.payload.psize?i.inbound=null:i.inbound=i.inbound.slice(i.payload.psize),i.processMsg(),i.pstate=0,i.payload=null,void 0!==t&&Date.now()-t>i.options.yieldTime)return i.stream.pause(),void setImmediate(i.processInbound.bind(this))}if(e&&!this.closed){var m=e[0].length;m>=i.inbound.length?i.inbound=null:i.inbound=i.inbound.slice(m)}e=null}},S.prototype.processServerUpdate=function(){var e=this;if(e.info.connect_urls&&e.info.connect_urls.length>0){var t={};e.info.connect_urls.forEach(function(e){var i="nats://"+e,n=new E(o.parse(i));n.implicit=!0,t[n.url.href]=n});var i=[];e.servers.forEach(function(n,s){var o=n.url.href;n.implicit&&e.currentServer.url.href!==o&&void 0===t[o]&&i.push(s),delete t[o]}),i.reverse(),i.forEach(function(t){e.servers.splice(t,1)});var n=[];for(var s in t)t.hasOwnProperty(s)&&(e.servers.push(t[s]),n.push(s));n.length&&e.emit("serversDiscovered",n)}},S.prototype.processMsg=function(){var e=this.subs[this.payload.sid];if(void 0!==e&&(e.received+=1,e.timeout&&e.received>=e.expected&&(clearTimeout(e.timeout),e.timeout=null),void 0!==e.max&&(e.received===e.max?(delete this.subs[this.payload.sid],this.emit("unsubscribe",this.payload.sid,e.subject)):e.received>e.max&&(this.unsubscribe(this.payload.sid),e.callback=null)),e.callback)){var t=this.payload.msg;if(this.options.json)try{t=this.options.preserveBuffers?JSON.parse(this.payload.msg.toString()):JSON.parse(this.payload.msg.toString(this.options.encoding))}catch(e){t=e}try{e.callback(t,this.payload.reply,this.payload.subj,this.payload.sid)}catch(e){this.emit("error",e)}}},S.prototype.processErr=function(e){var t=e?e.toLowerCase():"";-1!==t.indexOf("stale connection")?this.closeStream():-1!==t.indexOf("permissions violation")?this.emit("permission_error",new b(e,"NATS_PROTOCOL_ERR")):(this.emit("error",new b(e,"NATS_PROTOCOL_ERR")),this.closeStream())},S.prototype.addServer=function(e){this.servers.push(new E(o.parse(e))),!0!==this.options.noRandomize&&_(this.servers)},S.prototype.flush=function(e){if(this.closed){if("function"==typeof e)return void e(new b("Connection closed","CONN_CLOSED"));throw new b("Connection closed","CONN_CLOSED")}this.pongs&&(this.pongs.push(e),this.sendCommand("PING\r\n"),this.flushPending())},S.prototype.publish=function(e,t,i,n){if("function"==typeof e&&(n=e,e=void 0),t=this.options.json?void 0===t?null:t:t||"",!e){if(!n)throw new b("Subject must be supplied","BAD_SUBJECT");n(new b("Subject must be supplied","BAD_SUBJECT"))}if("function"==typeof t){if(n||i)return void n(new b("Message can't be a function","BAD_MSG"));n=t,t="",i=void 0}if("function"==typeof i){if(n)return void n(new b("Reply can't be a function","BAD_REPLY"));n=i,i=void 0}var s;if(s=void 0===i?"PUB "+e+" ":"PUB "+e+" "+i+" ",Buffer.isBuffer(t)){var o=Buffer.allocUnsafe(s.length+t.length+2*v+t.length.toString().length),r=o.write(s+t.length+g);t.copy(o,r),o.write(g,r+t.length),this.sendCommand(o)}else{var a=t;if(this.options.json)try{a=JSON.stringify(t)}catch(e){throw new b("Message should be a non-circular JSON-serializable value","BAD_JSON")}this.sendCommand(s+Buffer.byteLength(a)+g+a+g)}if(void 0!==n)this.flush(n);else if(this.closed)throw new b("Connection closed","CONN_CLOSED")},S.prototype.subscribe=function(e,t,i){if(this.closed)throw new b("Connection closed","CONN_CLOSED");var n,s,o;return"function"==typeof t?(i=t,t=void 0):t&&"object"==typeof t&&(n=t.queue,s=t.max),this.ssid+=1,this.subs[this.ssid]={subject:e,callback:i,received:0},"string"==typeof n?(this.subs[this.ssid].qgroup=n,o=["SUB",e,n,this.ssid+g]):o=["SUB",e,this.ssid+g],this.sendCommand(o.join(" ")),this.emit("subscribe",this.ssid,e,t),s&&this.unsubscribe(this.ssid,s),this.ssid},S.prototype.unsubscribe=function(e,t){if(e&&!this.closed)if(e<0)this.cancelMuxRequest(e);else{var i;i=t?["UNSUB",e,t+g]:["UNSUB",e+g],this.sendCommand(i.join(" "));var n=this.subs[e];void 0!==n&&(n.max=t,(void 0===n.max||n.received>=n.max)&&(n.timeout&&(clearTimeout(n.timeout),n.timeout=null),delete this.subs[e],this.emit("unsubscribe",e,n.subject)))}},S.prototype.timeout=function(e,t,i,n){if(e){var s=null;if(e<0){var o=this.getMuxRequestConfig(e);o&&o.timeout&&clearTimeout(o.timeout),s=o}else s=this.subs[e];if(s){s.expected=i;var r=this;s.timeout=setTimeout(function(){n(e),r.unsubscribe(e)},t)}}},S.prototype.request=function(e,t,i,n){if(this.options.useOldRequestStyle)return this.oldRequest(e,t,i,n);"function"==typeof t&&(n=t,t="",i=null),"function"==typeof i&&(n=i,i=null),i=i||{};var s=this.initMuxRequestDetails(n,i.max);if(this.publish(e,t,s.inbox),i.timeout){var o=this;s.timeout=setTimeout(function(){s.callback&&s.callback(new b("The request timed out for subscription id: "+s.id,"REQ_TIMEOUT")),o.cancelMuxRequest(s.token)},i.timeout)}return s.id},S.prototype.oldRequest=function(e,t,i,n){"function"==typeof t&&(n=t,t="",i=null),"function"==typeof i&&(n=i,i=null);var s=y(),o=this.subscribe(s,i,function(e,t){n(e,t)});return this.publish(e,t,s),o},S.prototype.requestOne=function(e,t,i,n,s){return this.options.useOldRequestStyle?this.oldRequestOne(e,t,i,n,s):("number"==typeof t&&(s=i,n=t,i=null,t=""),"number"==typeof i&&(s=n,n=i,i=null),(i=i||{}).max=1,i.timeout=n,this.request(e,t,i,s))},S.prototype.extractToken=function(e){return e.substr(this.respmux.inboxPrefixLen)},S.prototype.createResponseMux=function(){if(!this.respmux){var e=this,t=y(),i=t+".*",n=this.subscribe(i,function(t,i,n){var s=e.extractToken(n),o=e.getMuxRequestConfig(s);o&&(o.hasOwnProperty("expected")&&(o.received++,o.received>=o.expected&&e.cancelMuxRequest(s)),o.callback&&o.callback(t,i))});this.respmux={},this.respmux.inbox=t,this.respmux.inboxPrefixLen=t.length+1,this.respmux.subscriptionID=n,this.respmux.requestMap={},this.respmux.nextID=-1}return this.respmux.inbox},S.prototype.initMuxRequestDetails=function(e,t){var i=this.createResponseMux(),n=c.next(),s={token:n,callback:e,inbox:i+"."+n,id:this.respmux.nextID--,received:0};return t>0&&(s.expected=t),this.respmux.requestMap[n]=s,s},S.prototype.getMuxRequestConfig=function(e){if("number"==typeof e){var t=null;for(var i in this.respmux.requestMap)if(this.respmux.requestMap.hasOwnProperty(i)){var n=this.respmux.requestMap[i];if(n.id===e){t=n;break}}t&&(e=t.token)}return this.respmux.requestMap[e]},S.prototype.cancelMuxRequest=function(e){var t=this.getMuxRequestConfig(e);return t&&(t.timeout&&clearTimeout(t.timeout),delete this.respmux.requestMap[t.token]),t},S.prototype.oldRequestOne=function(e,t,i,n,s){"number"==typeof t&&(s=i,n=t,i=null,t=""),"number"==typeof i&&(s=n,n=i,i=null),(i=i||{}).max=1;var o=this.request(e,t,i,s);return this.timeout(o,n,1,function(){s(new b("The request timed out for subscription id: "+o,"REQ_TIMEOUT"))}),o},S.prototype.numSubscriptions=function(){return Object.keys(this.subs).length},S.prototype.reconnect=function(){this.closed||(this.reconnects+=1,this.createConnection(),!0===this.currentServer.didConnect&&this.emit("reconnecting"))},S.prototype.scheduleReconnect=function(){var e=this;if(0!==e.servers.length){!0===e.wasConnected&&(e.reconnecting=!0);var t=0;!0===e.servers[0].didConnect&&(t=this.options.reconnectTimeWait),setTimeout(function(){e.reconnect()},t)}}},function(e,t,i){var n=i(13),s=i(0),o=i(1).EventEmitter,r=n.isNode()?i(14).w3cwebsocket:window.WebSocket;function a(e){var t=this;o.call(this),n.isNode()?(this.sock=new r(e,"","*"),this.sock.onopen=function(){t.emit("connect")},this.sock.onmessage=function(e){t.emit("data",new Buffer(e.data))},this.sock.onerror=function(e){t.emit("error",e)},this.sock.onclose=function(){t.emit("close")}):(this.sock=new r(e),this.sock.addEventListener("open",function(){t.emit("connect")}),this.sock.addEventListener("message",function(e){t.emit("data",new Buffer(e.data))}),this.sock.addEventListener("error",function(e){t.emit("error",e)}),this.sock.addEventListener("close",function(){t.emit("close")}))}s.inherits(a,o),a.prototype.end=function(){this.destroy()},a.prototype.destroy=function(){this.sock.readyState!==r.CONNECTING&&this.sock.readyState!==r.OPEN||this.sock.close()},a.prototype.write=function(e){this.sock.readyState===r.OPEN&&this.sock.send(e)},a.prototype.pause=function(){console.warn("WebSocketProxy stream pause/resume is not supported yet.")},a.prototype.resume=function(){},t.createConnection=function(e){return new a(e.format({protocol:e.protocol,slashes:e.slashes,host:e.host,hostname:e.hostname,port:e.port,pathname:e.pathname,search:e.search,path:e.path,query:e.query,hash:e.hash}))}},function(e,t){e.exports={isNode:function(){return new Function("try { return this === global; } catch(e) { return false; }")}}},function(e,t,i){e.exports=i(15)},function(e,t,i){e.exports={server:i(16),client:i(10),router:i(31),frame:i(9),request:i(8),connection:i(5),w3cwebsocket:i(33),deprecation:i(39),version:i(40)}},function(e,t,i){var n=i(2).extend,s=i(2),o=i(0),r=i(6)("websocket:server"),a=i(1).EventEmitter,c=i(8),h=function(e){a.call(this),this._handlers={upgrade:this.handleUpgrade.bind(this),requestAccepted:this.handleRequestAccepted.bind(this),requestResolved:this.handleRequestResolved.bind(this)},this.connections=[],this.pendingRequests=[],e&&this.mount(e)};o.inherits(h,a),h.prototype.mount=function(e){if(this.config={httpServer:null,maxReceivedFrameSize:65536,maxReceivedMessageSize:1048576,fragmentOutgoingMessages:!0,fragmentationThreshold:16384,keepalive:!0,keepaliveInterval:2e4,dropConnectionOnKeepaliveTimeout:!0,keepaliveGracePeriod:1e4,useNativeKeepalive:!1,assembleFragments:!0,autoAcceptConnections:!1,ignoreXForwardedFor:!1,disableNagleAlgorithm:!0,closeTimeout:5e3},n(this.config,e),!this.config.httpServer)throw new Error("You must specify an httpServer on which to mount the WebSocket server.");Array.isArray(this.config.httpServer)||(this.config.httpServer=[this.config.httpServer]);var t=this._handlers.upgrade;this.config.httpServer.forEach(function(e){e.on("upgrade",t)})},h.prototype.unmount=function(){var e=this._handlers.upgrade;this.config.httpServer.forEach(function(t){t.removeListener("upgrade",e)})},h.prototype.closeAllConnections=function(){this.connections.forEach(function(e){e.close()}),this.pendingRequests.forEach(function(e){process.nextTick(function(){e.reject(503)})})},h.prototype.broadcast=function(e){Buffer.isBuffer(e)?this.broadcastBytes(e):"function"==typeof e.toString&&this.broadcastUTF(e)},h.prototype.broadcastUTF=function(e){this.connections.forEach(function(t){t.sendUTF(e)})},h.prototype.broadcastBytes=function(e){this.connections.forEach(function(t){t.sendBytes(e)})},h.prototype.shutDown=function(){this.unmount(),this.closeAllConnections()},h.prototype.handleUpgrade=function(e,t){var i=new c(t,e,this.config);try{i.readHandshake()}catch(e){return i.reject(e.httpCode?e.httpCode:400,e.message,e.headers),void r("Invalid handshake: %s",e.message)}this.pendingRequests.push(i),i.once("requestAccepted",this._handlers.requestAccepted),i.once("requestResolved",this._handlers.requestResolved),!this.config.autoAcceptConnections&&s.eventEmitterListenerCount(this,"request")>0?this.emit("request",i):this.config.autoAcceptConnections?i.accept(i.requestedProtocols[0],i.origin):i.reject(404,"No handler is configured to accept the connection.")},h.prototype.handleRequestAccepted=function(e){var t=this;e.once("close",function(i,n){t.handleConnectionClose(e,i,n)}),this.connections.push(e),this.emit("connect",e)},h.prototype.handleConnectionClose=function(e,t,i){var n=this.connections.indexOf(e);-1!==n&&this.connections.splice(n,1),this.emit("close",e,t,i)},h.prototype.handleRequestResolved=function(e){var t=this.pendingRequests.indexOf(e);-1!==t&&this.pendingRequests.splice(t,1)},e.exports=h},function(e,t,i){function n(){var e;try{e=t.storage.debug}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e}(t=e.exports=i(7)).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(e){var i=this.useColors;if(e[0]=(i?"%c":"")+this.namespace+(i?" %c":" ")+e[0]+(i?"%c ":" ")+"+"+t.humanize(this.diff),!i)return;var n="color: "+this.color;e.splice(1,0,n,"color: inherit");var s=0,o=0;e[0].replace(/%[a-zA-Z%]/g,function(e){"%%"!==e&&"%c"===e&&(o=++s)}),e.splice(o,0,n)},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(n())},function(e,t){var i=1e3,n=60*i,s=60*n,o=24*s,r=365.25*o;function a(e,t,i){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+i:Math.ceil(e/t)+" "+i+"s"}e.exports=function(e,t){t=t||{};var c=typeof e;if("string"===c&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var a=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return a*r;case"days":case"day":case"d":return a*o;case"hours":case"hour":case"hrs":case"hr":case"h":return a*s;case"minutes":case"minute":case"mins":case"min":case"m":return a*n;case"seconds":case"second":case"secs":case"sec":case"s":return a*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return a;default:return}}(e);if("number"===c&&!1===isNaN(e))return t.long?function(e){return a(e,o,"day")||a(e,s,"hour")||a(e,n,"minute")||a(e,i,"second")||e+" ms"}(e):function(e){if(e>=o)return Math.round(e/o)+"d";if(e>=s)return Math.round(e/s)+"h";if(e>=n)return Math.round(e/n)+"m";if(e>=i)return Math.round(e/i)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,i){var n=i(20),s=i(0);(t=e.exports=i(7)).init=function(e){e.inspectOpts={};for(var i=Object.keys(t.inspectOpts),n=0;n<i.length;n++)e.inspectOpts[i[n]]=t.inspectOpts[i[n]]},t.log=function(){return r.write(s.format.apply(s,arguments)+"\n")},t.formatArgs=function(e){var i=this.namespace;if(this.useColors){var n=this.color,s="  [3"+n+";1m"+i+" [0m";e[0]=s+e[0].split("\n").join("\n"+s),e.push("[3"+n+"m+"+t.humanize(this.diff)+"[0m")}else e[0]=(new Date).toUTCString()+" "+i+" "+e[0]},t.save=function(e){null==e?delete process.env.DEBUG:process.env.DEBUG=e},t.load=a,t.useColors=function(){return"colors"in t.inspectOpts?Boolean(t.inspectOpts.colors):n.isatty(o)},t.colors=[6,2,3,4,5,1],t.inspectOpts=Object.keys(process.env).filter(function(e){return/^debug_/i.test(e)}).reduce(function(e,t){var i=t.substring(6).toLowerCase().replace(/_([a-z])/g,function(e,t){return t.toUpperCase()}),n=process.env[t];return n=!!/^(yes|on|true|enabled)$/i.test(n)||!/^(no|off|false|disabled)$/i.test(n)&&("null"===n?null:Number(n)),e[i]=n,e},{});var o=parseInt(process.env.DEBUG_FD,10)||2;1!==o&&2!==o&&s.deprecate(function(){},"except for stderr(2) and stdout(1), any other usage of DEBUG_FD is deprecated. Override debug.log if you want to use a different log function (https://git.io/debug_fd)")();var r=1===o?process.stdout:2===o?process.stderr:function(e){var t;switch(process.binding("tty_wrap").guessHandleType(e)){case"TTY":(t=new n.WriteStream(e))._type="tty",t._handle&&t._handle.unref&&t._handle.unref();break;case"FILE":var s=i(21);(t=new s.SyncWriteStream(e,{autoClose:!1}))._type="fs";break;case"PIPE":case"TCP":var o=i(22);(t=new o.Socket({fd:e,readable:!1,writable:!0})).readable=!1,t.read=null,t._type="pipe",t._handle&&t._handle.unref&&t._handle.unref();break;default:throw new Error("Implement me. Unknown stream file type!")}return t.fd=e,t._isStdio=!0,t}(o);function a(){return process.env.DEBUG}t.formatters.o=function(e){return this.inspectOpts.colors=this.useColors,s.inspect(e,this.inspectOpts).split("\n").map(function(e){return e.trim()}).join(" ")},t.formatters.O=function(e){return this.inspectOpts.colors=this.useColors,s.inspect(e,this.inspectOpts)},t.enable(a())},function(e,t){e.exports=require("tty")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("net")},function(e,t,i){
/*!
 * Copied from:
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */
try{e.exports=i(!function(){var e=new Error("Cannot find module '../build/Release/bufferutil'");throw e.code="MODULE_NOT_FOUND",e}())}catch(t){try{e.exports=i(!function(){var e=new Error("Cannot find module '../build/default/bufferutil'");throw e.code="MODULE_NOT_FOUND",e}())}catch(t){try{e.exports=i(24)}catch(e){throw console.error("bufferutil.node seems to not have been built. Run npm install."),e}}}},function(e,t){
/*!
 * Copied from:
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */
e.exports.BufferUtil={merge:function(e,t){for(var i=0,n=0,s=t.length;n<s;++n){var o=t[n];o.copy(e,i),i+=o.length}},mask:function(e,t,i,n,s){for(var o=t.readUInt32LE(0),r=0;r<s-3;r+=4){var a=o^e.readUInt32LE(r);a<0&&(a=4294967296+a),i.writeUInt32LE(a,n+r)}switch(s%4){case 3:i[n+r+2]=e[r+2]^t[2];case 2:i[n+r+1]=e[r+1]^t[1];case 1:i[n+r]=e[r]^t[0]}},unmask:function(e,t){for(var i=t.readUInt32LE(0),n=e.length,s=0;s<n-3;s+=4){var o=i^e.readUInt32LE(s);o<0&&(o=4294967296+o),e.writeUInt32LE(o,s)}switch(n%4){case 3:e[s+2]=e[s+2]^t[2];case 2:e[s+1]=e[s+1]^t[1];case 1:e[s]=e[s]^t[0]}}}},function(e,t,i){var n=i(26).Buffer,s=i(1).EventEmitter,o=i(2).bufferAllocUnsafe;function r(e){if(!(this instanceof r))return new r(e);s.call(this);var t=this;void 0===e&&(e={}),t.encoding=e.encoding;var i={next:null,buffer:null},a={next:null,buffer:null},c=0;t.__defineGetter__("length",function(){return c});var h=0;t.write=function(e){return i.buffer?(a.next={next:null,buffer:e},a=a.next):(i.buffer=e,a=i),c+=e.length,t.emit("write",e),!0},t.end=function(e){n.isBuffer(e)&&t.write(e)},t.push=function(){return[].concat.apply([],arguments).forEach(t.write),t},t.forEach=function(e){if(!i.buffer)return o(0);if(i.buffer.length-h<=0)return t;for(var n={buffer:i.buffer.slice(h),next:i.next};n&&n.buffer;){if(e(n.buffer))break;n=n.next}return t},t.join=function(e,n){if(!i.buffer)return o(0);void 0==e&&(e=0),void 0==n&&(n=t.length);var s=o(n-e),r=0;return t.forEach(function(t){if(e<r+t.length&&r<n&&t.copy(s,Math.max(0,r-e),Math.max(0,e-r),Math.min(t.length,n-r)),(r+=t.length)>n)return!0}),s},t.joinInto=function(e,n,s,r){if(!i.buffer)return new o(0);void 0==s&&(s=0),void 0==r&&(r=t.length);var a=e;if(a.length-n<r-s)throw new Error("Insufficient space available in target Buffer.");var c=0;return t.forEach(function(e){if(s<c+e.length&&c<r&&e.copy(a,Math.max(n,n+c-s),Math.max(0,s-c),Math.min(e.length,r-c)),(c+=e.length)>r)return!0}),a},t.advance=function(e){for(h+=e,c-=e;i.buffer&&h>=i.buffer.length;)h-=i.buffer.length,i=i.next?i.next:{buffer:null,next:null};return null===i.buffer&&(a={next:null,buffer:null}),t.emit("advance",e),t},t.take=function(e,i){void 0==e?e=t.length:"number"!=typeof e&&(i=e,e=t.length);if(i||(i=t.encoding),i){var n="";return t.forEach(function(t){if(e<=0)return!0;n+=t.toString(i,0,Math.min(e,t.length)),e-=t.length}),n}return t.join(0,e)},t.toString=function(){return t.take("binary")}}e.exports=r,e.exports.BufferList=r,i(0).inherits(r,s)},function(e,t){e.exports=require("buffer")},function(e,t,i){
/*!
 * UTF-8 Validation Code originally from:
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */
try{e.exports=i(!function(){var e=new Error("Cannot find module '../build/Release/validation'");throw e.code="MODULE_NOT_FOUND",e}())}catch(t){try{e.exports=i(!function(){var e=new Error("Cannot find module '../build/default/validation'");throw e.code="MODULE_NOT_FOUND",e}())}catch(t){try{e.exports=i(28)}catch(e){throw console.error("validation.node seems not to have been built. Run npm install."),e}}}},function(e,t){
/*!
 * UTF-8 Validation Fallback Code originally from:
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */
e.exports.Validation={isValidUTF8:function(){return!0}}},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("https")},function(e,t,i){var n=i(2).extend,s=i(0),o=i(1).EventEmitter,r=i(32);function a(e){o.call(this),this.config={server:null},e&&n(this.config,e),this.handlers=[],this._requestHandler=this.handleRequest.bind(this),this.config.server&&this.attachServer(this.config.server)}s.inherits(a,o),a.prototype.attachServer=function(e){if(!e)throw new Error("You must specify a WebSocketServer instance to attach to.");this.server=e,this.server.on("request",this._requestHandler)},a.prototype.detachServer=function(){if(!this.server)throw new Error("Cannot detach from server: not attached.");this.server.removeListener("request",this._requestHandler),this.server=null},a.prototype.mount=function(e,t,i){if(!e)throw new Error("You must specify a path for this handler.");if(t||(t="____no_protocol____"),!i)throw new Error("You must specify a callback for this handler.");if(!((e=this.pathToRegExp(e))instanceof RegExp))throw new Error("Path must be specified as either a string or a RegExp.");var n=e.toString();if(t=t.toLocaleLowerCase(),-1!==this.findHandlerIndex(n,t))throw new Error("You may only mount one handler per path/protocol combination.");this.handlers.push({path:e,pathString:n,protocol:t,callback:i})},a.prototype.unmount=function(e,t){var i=this.findHandlerIndex(this.pathToRegExp(e).toString(),t);if(-1===i)throw new Error("Unable to find a route matching the specified path and protocol.");this.handlers.splice(i,1)},a.prototype.findHandlerIndex=function(e,t){t=t.toLocaleLowerCase();for(var i=0,n=this.handlers.length;i<n;i++){var s=this.handlers[i];if(s.pathString===e&&s.protocol===t)return i}return-1},a.prototype.pathToRegExp=function(e){return"string"==typeof e&&("*"===e?e=/^.*$/:(e=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),e=new RegExp("^"+e+"$"))),e},a.prototype.handleRequest=function(e){var t=e.requestedProtocols;0===t.length&&(t=["____no_protocol____"]);for(var i=0;i<t.length;i++)for(var n=t[i].toLocaleLowerCase(),s=0,o=this.handlers.length;s<o;s++){var a=this.handlers[s];if(a.path.test(e.resourceURL.pathname)&&(n===a.protocol||"*"===a.protocol)){var c=new r(e,n);return void a.callback(c)}}e.reject(404,"No handler is available for the given request.")},e.exports=a},function(e,t,i){var n=i(0),s=i(1).EventEmitter;function o(e,t){s.call(this),this.webSocketRequest=e,this.protocol="____no_protocol____"===t?null:t,this.origin=e.origin,this.resource=e.resource,this.resourceURL=e.resourceURL,this.httpRequest=e.httpRequest,this.remoteAddress=e.remoteAddress,this.webSocketVersion=e.webSocketVersion,this.requestedExtensions=e.requestedExtensions,this.cookies=e.cookies}n.inherits(o,s),o.prototype.accept=function(e,t){var i=this.webSocketRequest.accept(this.protocol,e,t);return this.emit("requestAccepted",i),i},o.prototype.reject=function(e,t,i){this.webSocketRequest.reject(e,t,i),this.emit("requestRejected",this)},e.exports=o},function(e,t,i){var n=i(10),s=i(34),o=i(36);const r=0,a=1,c=2,h=3;function u(e,t,i,s,c,u){o.EventTarget.call(this),(u=u||{}).assembleFragments=!0;var m=this;this._url=e,this._readyState=r,this._protocol=void 0,this._extensions="",this._bufferedAmount=0,this._binaryType="arraybuffer",this._connection=void 0,this._client=new n(u),this._client.on("connect",function(e){(function(e){var t=this;this._readyState=a,this._connection=e,this._protocol=e.protocol,this._extensions=e.extensions,this._connection.on("close",function(e,i){(function(e,t){f.call(this),this._readyState=h,this.dispatchEvent(l(e,t||""))}).call(t,e,i)}),this._connection.on("message",function(e){(function(e){if(e.utf8Data)this.dispatchEvent(d(e.utf8Data));else if(e.binaryData&&"arraybuffer"===this.binaryType){for(var t=e.binaryData,i=new ArrayBuffer(t.length),n=new Uint8Array(i),s=0,o=t.length;s<o;++s)n[s]=t[s];this.dispatchEvent(d(i))}}).call(t,e)}),this.dispatchEvent(new o.Event("open"))}).call(m,e)}),this._client.on("connectFailed",function(){p.call(m)}),this._client.connect(e,t,i,s,c)}function l(e,t){var i=new o.Event("close");return i.code=e,i.reason=t,i.wasClean=void 0===e||1e3===e,i}function d(e){var t=new o.Event("message");return t.data=e,t}function p(){f.call(this),this._readyState=h;try{this.dispatchEvent(new o.Event("error"))}finally{this.dispatchEvent(l(1006,"connection failed"))}}function f(){this._client.removeAllListeners(),this._connection&&this._connection.removeAllListeners()}e.exports=u,Object.defineProperties(u.prototype,{url:{get:function(){return this._url}},readyState:{get:function(){return this._readyState}},protocol:{get:function(){return this._protocol}},extensions:{get:function(){return this._extensions}},bufferedAmount:{get:function(){return this._bufferedAmount}}}),Object.defineProperties(u.prototype,{binaryType:{get:function(){return this._binaryType},set:function(e){if("arraybuffer"!==e)throw new SyntaxError('just "arraybuffer" type allowed for "binaryType" attribute');this._binaryType=e}}}),[["CONNECTING",r],["OPEN",a],["CLOSING",c],["CLOSED",h]].forEach(function(e){Object.defineProperty(u.prototype,e[0],{get:function(){return e[1]}})}),[["CONNECTING",r],["OPEN",a],["CLOSING",c],["CLOSED",h]].forEach(function(e){Object.defineProperty(u,e[0],{get:function(){return e[1]}})}),u.prototype.send=function(e){if(this._readyState!==a)throw new Error("cannot call send() while not connected");if("string"==typeof e||e instanceof String)this._connection.sendUTF(e);else if(e instanceof Buffer)this._connection.sendBytes(e);else{if(!e.byteLength&&0!==e.byteLength)throw new Error("unknown binary data:",e);e=s(e),this._connection.sendBytes(e)}},u.prototype.close=function(e,t){switch(this._readyState){case r:p.call(this),this._client.on("connect",function(i){e?i.close(e,t):i.close()});break;case a:this._readyState=c,e?this._connection.close(e,t):this._connection.close()}}},function(e,t,i){var n=i(35).strict;e.exports=function(e){if(n(e)){var t=Buffer.from(e.buffer);return e.byteLength!==e.buffer.byteLength&&(t=t.slice(e.byteOffset,e.byteOffset+e.byteLength)),t}return Buffer.from(e)}},function(e,t){e.exports=s,s.strict=o,s.loose=r;var i=Object.prototype.toString,n={"[object Int8Array]":!0,"[object Int16Array]":!0,"[object Int32Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Uint16Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0};function s(e){return o(e)||r(e)}function o(e){return e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array}function r(e){return n[i.call(e)]}},function(e,t,i){e.exports={EventTarget:i(37),Event:i(38)}},function(e,t){function i(){"function"!=typeof this.addEventListener&&(this._listeners={},this.addEventListener=n,this.removeEventListener=s,this.dispatchEvent=o)}function n(e,t){var i,n,s;if(e&&t){for(void 0===(i=this._listeners[e])&&(this._listeners[e]=i=[]),n=0;s=i[n];n++)if(s===t)return;i.push(t)}}function s(e,t){var i,n,s;if(e&&t&&void 0!==(i=this._listeners[e])){for(n=0;s=i[n];n++)if(s===t){i.splice(n,1);break}0===i.length&&delete this._listeners[e]}}function o(e){var t,i,n,s,o,r=!1;if(!e||"string"!=typeof e.type)throw new Error("`event` must have a valid `type` property");e._yaeti&&(e.target=this,e.cancelable=!0);try{e.stopImmediatePropagation=function(){r=!0}}catch(e){}for(t=e.type,i=this._listeners[t]||[],"function"==typeof(n=this["on"+t])&&n.call(this,e),s=0;(o=i[s])&&!r;s++)o.call(this,e);return!e.defaultPrevented}e.exports=i,Object.defineProperties(i.prototype,{listeners:{get:function(){return this._listeners}}})},function(e,t){e.exports=function(e){this.type=e,this.isTrusted=!1,this._yaeti=!0}},function(e,t){var i={disableWarnings:!1,deprecationWarningMap:{},warn:function(e){!this.disableWarnings&&this.deprecationWarningMap[e]&&(console.warn("DEPRECATION WARNING: "+this.deprecationWarningMap[e]),this.deprecationWarningMap[e]=!1)}};e.exports=i},function(e,t,i){e.exports=i(41).version},function(e){e.exports={_from:"websocket@latest",_id:"websocket@1.0.28",_inBundle:!1,_integrity:"sha512-00y/20/80P7H4bCYkzuuvvfDvh+dgtXi5kzDf3UcZwN6boTYaKvsrtZ5lIYm1Gsg48siMErd9M4zjSYfYFHTrA==",_location:"/websocket",_phantomChildren:{},_requested:{type:"tag",registry:!0,raw:"websocket@latest",name:"websocket",escapedName:"websocket",rawSpec:"latest",saveSpec:null,fetchSpec:"latest"},_requiredBy:["/"],_resolved:"https://registry.npmjs.org/websocket/-/websocket-1.0.28.tgz",_shasum:"9e5f6fdc8a3fe01d4422647ef93abdd8d45a78d3",_spec:"websocket@latest",_where:"/Users/aaguilar/repos/ws-nats",author:{name:"Brian McKelvey",email:"theturtle32@gmail.com",url:"https://github.com/theturtle32"},browser:"lib/browser.js",bugs:{url:"https://github.com/theturtle32/WebSocket-Node/issues"},bundleDependencies:!1,config:{verbose:!1},contributors:[{name:"Iñaki Baz Castillo",email:"ibc@aliax.net",url:"http://dev.sipdoc.net"}],dependencies:{debug:"^2.2.0",nan:"^2.11.0","typedarray-to-buffer":"^3.1.5",yaeti:"^0.0.6"},deprecated:!1,description:"Websocket Client & Server Library implementing the WebSocket protocol as specified in RFC 6455.",devDependencies:{"buffer-equal":"^1.0.0",faucet:"^0.0.1",gulp:"git+https://github.com/gulpjs/gulp.git#4.0","gulp-jshint":"^2.0.4",jshint:"^2.0.0","jshint-stylish":"^2.2.1",tape:"^4.9.1"},directories:{lib:"./lib"},engines:{node:">=0.10.0"},homepage:"https://github.com/theturtle32/WebSocket-Node",keywords:["websocket","websockets","socket","networking","comet","push","RFC-6455","realtime","server","client"],license:"Apache-2.0",main:"index",name:"websocket",repository:{type:"git",url:"git+https://github.com/theturtle32/WebSocket-Node.git"},scripts:{gulp:"gulp",install:"(node-gyp rebuild 2> builderror.log) || (exit 0)",test:"faucet test/unit"},version:"1.0.28"}},function(e,t){t.connect=function(e,t){throw"TLS is not supported in the browser. Use WSS instead."}},function(e,t,i){"use strict";var n=i(3),s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",o=22;function r(){this.buf=Buffer.alloc(o),this.init()}t.version="1.0.0",r.prototype.init=function(){this.setPre(),this.initSeqAndInc(),this.fillSeq()},r.prototype.initSeqAndInc=function(){this.seq=Math.floor(0xcfd41b9100000*Math.random()),this.inc=Math.floor(300*Math.random()+33)},r.prototype.setPre=function(){for(var e=n.randomBytes(12),t=0;t<12;t++){var i=e[t]%36;this.buf[t]=s.charCodeAt(i)}},r.prototype.fillSeq=function(){for(var e=this.seq,t=o-1;t>=12;t--)this.buf[t]=s.charCodeAt(e%36),e=Math.floor(e/36)},r.prototype.next=function(){return this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),this.buf.toString("ascii")};var a=new r;t.reset=function(){a.init()},t.next=function(){return a.next()},t._global=a}]));